<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="The blog of Christopher Martinez, a software developer from Fresno."><title>[archive] Static analysis tools for PHP</title><link rel=canonical href=https://chrsm.org/2013/05/05/archive-static-analysis-tools-for-php/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;line-height:160%;color:#1d1313;max-width:700px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3{font-family:old standard tt,serif}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h2 a,h3 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}:root{--darkreader-neutral-background:#181a1b;--darkreader-neutral-text:#e8e6e3;--darkreader-selection-background:#004daa;--darkreader-selection-text:#e8e6e3}html{background-color:#181a1b!important}html,body,input,textarea,select,button{background-color:#181a1b}html,body,input,textarea,select,button{border-color:#736b5e;color:#e8e6e3}a{color:#3391ff}table{border-color:#545b5e}::placeholder{color:#b2aba1}input:-webkit-autofill,textarea:-webkit-autofill,select:-webkit-autofill{background-color:#555b00!important;color:#e8e6e3!important}::-webkit-scrollbar{background-color:#202324;color:#aba499}::-webkit-scrollbar-thumb{background-color:#454a4d}::-webkit-scrollbar-thumb:hover{background-color:#575e62}::-webkit-scrollbar-thumb:active{background-color:#484e51}::-webkit-scrollbar-corner{background-color:#181a1b}*{scrollbar-color:#202324 #454a4d}::selection{background-color:#004daa!important;color:#e8e6e3!important}::-moz-selection{background-color:#004daa!important;color:#e8e6e3!important}</style></head><body><section id=nav><h1><a href=https://chrsm.org/></a></h1><ul><li><a href=https://chrsm.org/>~/</a></li><li><a href=https://chrsm.org/about>~/about</a></li><li><a href=https://github.com/chrsm>~/github</a></li></ul></section><section id=content><h1>[archive] Static analysis tools for PHP</h1><div id=sub-header>May 2013 Â· 8 minute read</div><div class=entry-content><p>I believe in writing code that is easy to understand, easy to test, and easy to refactor.</p><p>Yes, I realize that the statement above is pretty general and open to interpretation. Not everyone needs external tools to ensure quality in their code&mldr;but, I work on things from time to time that have absolutely no tests. No unit tests, no functional tests, no browser tests, no code quality analysis. Needless to say, some of those things make me want to tear my eyes out. Frankly, though, when a project hits success, there is rarely time to go back and ensure quality of old code - instead, we find ourselves merely bolting on new things. Writing software does not have to be this way.</p><p>For whatever reason, this happens a lot more frequently in the PHP world. I&rsquo;m guilty of not writing tests and checking how I write code, sometimes, too. Things are bright, though, for the PHP community - for quite some time now, we&rsquo;ve had fantastic tools that assist us in writing better code. The fact that these tools are available is evident to all - but, if you&rsquo;ve found yourself wondering just why you&rsquo;d want to use some of them, read on and explore your options. I will do my best to explain what each tool is for, as well as explain how I&rsquo;ve built these in to my workflow.</p><p>I won&rsquo;t cover tools like PHPUnit here, since they&rsquo;re not necessarily automated - while unit tests can help you uncover bugs or prevent regressions, they still need to be written first.</p><p><em>Note: This post is extremely dry, and I apologize for that in advance. If you want more or specific information, feel free to contact me - I&rsquo;d love to hear from you.</em></p><ul><li><a href=#phpmd>PHP Mess Detector</a></li><li><a href=#phpcpd>PHP Copy/Paste Detector</a></li><li><a href=#phpcs>PHP CodeSniffer</a></li><li><a href=#phpalizer>PHP Analyzer</a></li><li><a href=#pfff>Pfff</a></li><li><a href=#build>How I use these tools in every day work</a></li></ul><p>PHPMD can be invoked from the command line like so:</p><pre><code>phpmd {directory} {report format} {rules}

$ phpmd . text codesize,unusedcode 

/src/xxxxxx/api/src/base/Model.php:75    The method __toArray() has a Cyclomatic Complexity of 12. The configured cyclomatic complexity threshold is 10.
/src/xxxxxx/api/src/controller/Users.php:235    Avoid unused parameters such as '$request'.
/src/xxxxxx/api/src/controller/Users.php:246    Avoid unused local variables such as '$x'.
/src/xxxxxx/api/src/controller/Users.php:246    Avoid unused local variables such as '$undeclared'.
/src/xxxxxx/api/src/base/Controller.php    -    Unexpected token: [, line: 88, col: 56, file: /src/xxxxxx/api/src/base/Controller.php.
</code></pre><p>The project I&rsquo;m running PHPMD on isn&rsquo;t very large at the moment, so I added some issues that it could pick up on.
I only used the code size and unused code rules, but <a href=http://phpmd.org/rules/>there are a few more</a> that are available.
Each one of these can either be ignored or configured to taste - for example, the minimum name length for a method on a class with stock PHPMD is three.
I lowered this to two in one specific subset of what I run the tool on.</p><p>As an aside, if you are unfamiliar with <a href=http://en.wikipedia.org/wiki/Cyclomatic_complexity>cyclomatic complexity</a>, <a href=http://pdepend.org/documentation/software-metrics/cyclomatic-complexity.html>take a few minutes to read</a> about it.
It is inevitable that you will have some code that is too complicated, but absolutely unnecessary to refactor.
That being said, you may not always be the person working on your code - so do it anyways!</p><p>PHPCPD can be invoked via the command line like so:</p><pre><code>phpcpd {directory or file}
</code></pre><p>PHPCPD also has some useful command line switches that you can use to adjust its analysis. For example, you can control the minimum lines of code that must be the same in order to trigger output (&ndash;minimum-lines) or a minimum amount of tokens (&ndash;minimum-tokens), exclude directories (&ndash;exclude) or only check specific files (&ndash;names). If you want to see the exact code that is duplicated, you can also use the &ndash;verbose switch to write the code to stdout.</p><p>Here&rsquo;s a somewhat contrived example from the same project as above.</p><pre><code>phpcpd --verbose .
phpcpd 1.4.1 by Sebastian Bergmann.

Found 2 exact clones with 23 duplicated lines in 4 files:

- /src/xxxx/api/src/model/Xxxx.php:9-25
/src/xxxx/api/src/model/Xxxx.php:9-25

namespace app\model;

use app\base\Model;

use morph\property\String;
use morph\property\Integer;

class Xxxx extends Model
{

    public function __construct($id = null)
    {
        parent::__construct($id);

        $this-&amp;gt;addProperty(new String('name'))-&gt;addValidator('name', 'string,min:3,max:255');

- /src/xxxx/api/src/model/Xxxxx.php:65-72
/src/xxxx/api/src/model/Xxxxx.php:53-60

        if ((string) $x-&gt;id() == (string) $id) {
            unset($this-&gt;xxxx[$index]);
            break;
        }
    }

    return $this;

1.38% duplicated lines out of 1666 total lines of code.

Time: 0 seconds, Memory: 3.50Mb
</code></pre><p>As you can see, it picks up two models that have similar code dealing with removing data from an property set.
Instead of having this code in two separate places, it could either be moved to the models&rsquo; parent or into a trait
(if it was functionality that it begged to be in a trait, of course).</p><p>PHPCS is easily invoked from the command line via:</p><pre><code>phpcs --standard={comma-separated rulesets} {directory}
</code></pre><p>With PHPCS&rsquo; output, it is trivial to maintain style guidelines in any project. Example output from the same project I&rsquo;m boring you all with so far:</p><pre><code>$ phpcs --standard=PSR1,PSR2 .
FILE: /src/xxxx/api/src/exception/Xxx.php
--------------------------------------------------------------------------------
FOUND 1 ERROR(S) AFFECTING 1 LINE(S)
--------------------------------------------------------------------------------
15 | ERROR | The closing brace for the class must go on the next line after | | the body
--------------------------------------------------------------------------------

Time: 0 seconds, Memory: 5.25Mb
</code></pre><p>As someone working with another developer, style consistency is truly helpful.
No two people code exactly the same, and when everyone injects their own way of doing things into the code, things tend to get messy.
This is why PHPCS is so great - you don&rsquo;t have to use the standards that ship with it as it is easy to write your own.
When all of your codebase follows the same standard, anyone can drop in and be able to read the code without having to mentally switch to the last developer
to touch the code&rsquo;s style.</p><p>You can invoke PHP analyzer via the CLI like so:</p><pre><code>phpalizer run {directory}
</code></pre><p>Depending on the size of your codebase, the analysis can take a long time, especially when it attempts type interference.
There are a few things it does not yet understand, which I&rsquo;ll describe after the following example output.</p><pre><code>$ phpalizer run .
Messeduponpurpose.php
=============
Line 25: The variable ``$b`` does not exist. Did you forget to declare it?
Line 27: The assignment to ``$a`` is dead and can be removed.

model/Xxxxx.php
=================
Line 16: There is at least one abstract method in this class. Maybe declare it as abstract, or implement the remaining methods: isValid, getInvalidData

model/BrokenUser.php
==============
Line 17: There is at least one abstract method in this class. Maybe declare it as abstract, or implement the remaining methods: isValid, getInvalidData
Line 56: ``str_split($password, 72)`` cannot be passed to ``array_shift()`` as the parameter ``$array`` expects a reference.

httpkernel/ControllerResolver.php
=================================
Line 22: There is one abstract method ``setApplication`` in this class; you could implement it, or declare this class as abstract.

Done
</code></pre><p>The first example, &ldquo;Messeduponpurpose.php&rdquo;, is actually bad code. There&rsquo;s a function that uses variables which don&rsquo;t exist, as well as accepting arguments which are never used.
The immediate next example is completely wrong, which I believe is due to PHP Analyzer&rsquo;s lack of grasping traits (when used by a parent, and not the actual object it is currently checking). The &ldquo;BrokenUser&rdquo; model gets the same treatment.
The second issue it mentions about str_split and array_shift is actually a non-issue.</p><p>Unfortunately, the pfff tools are also tricky to build on some systems.
I built it on a virtual machine using Debian&rsquo;s experimental packages and moved them over to the host - your mileage may vary.</p><p>The pfff toolchain allows you to perform static <em>and</em> dynamic analysis of your projects and build visual interpretations of it all -
quickly, unlike most of the other tools mentioned here.</p><p>Unfortunately, I can&rsquo;t share any examples here since I&rsquo;ve already thoroughly taken advantage of everything it has to offer. That being said, I still recommend that you check it out and use it on anything that you can.</p><pre><code>$ cd {repo}

$ nano .git/hooks/pre-commit
    grunt precommit
</code></pre><p>And that&rsquo;s it. Really. If any of the tasks in the pre-commit step fail, I&rsquo;ll see some errors and be forced to fix them before
committing anything that can lead to a broken build. Prior to my learning git-svn (yes, I have to use SVN on some projects still),
I wrote a simple bash script that did pretty much the same as the above. If you&rsquo;re forced to use SVN for work, but can install
software on your own machine, I strongly suggest that you instead learn to use git-svn and just use a pre-commit hook.
It will save you a lot of headaches. If you&rsquo;re not a fan of Grunt, you can use Phing, Ant, or a simple script that just
checks the return code or output of each tool.</p><p>I&rsquo;m in the process of working on using the same virtual machine I used to build pfff to save a history of each commit someone makes to any of the repositories I have access to - a sort of &ldquo;private&rdquo; continuous testing server. Once that&rsquo;s done, I will probably make another post about how I set it up.</p></div><div id=links><a class="basic-alignment left" href=https://chrsm.org/2014/05/20/archive-environments-go/>[archive] Environments & Go &#187;</a></div></section></body></html>