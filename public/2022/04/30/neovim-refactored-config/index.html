<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=HandheldFriendly content="True"><meta name=MobileOptimized content="320"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=referrer content="no-referrer"><meta name=description content="The blog of Christopher Martinez, a software developer from Fresno."><title>neovim: refactored config</title><link rel=canonical href=https://chrsm.org/2022/04/30/neovim-refactored-config/><style>*{border:0;font:inherit;font-size:100%;vertical-align:baseline;margin:0;padding:0;color:#000;text-decoration-skip:ink}body{font-family:open sans,myriad pro,Myriad,sans-serif;font-size:17px;line-height:160%;color:#1d1313;max-width:700px;margin:auto}p{margin:20px 0}a img{border:none}img{margin:10px auto;max-width:100%;display:block}.left-justify{float:left}.right-justify{float:right}pre,code{font:12px Consolas,liberation mono,Menlo,Courier,monospace;background-color:#f7f7f7}code{font-size:12px;padding:4px}pre{margin-top:0;margin-bottom:16px;word-wrap:normal;padding:16px;overflow:auto;font-size:85%;line-height:1.45}pre>code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:0 0;border:0}pre code{display:inline;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:transparent;border:0}pre code::before,pre code::after{content:normal}em,q,em,dfn{font-style:italic}.sans,html .gist .gist-file .gist-meta{font-family:open sans,myriad pro,Myriad,sans-serif}.mono,pre,code,tt,p code,li code{font-family:Menlo,Monaco,andale mono,lucida console,courier new,monospace}.heading,.serif,h1,h2,h3{font-family:old standard tt,serif}strong{font-weight:600}q:before{content:"\201C"}q:after{content:"\201D"}del,s{text-decoration:line-through}blockquote{font-family:old standard tt,serif;text-align:center;padding:50px}blockquote p{display:inline-block;font-style:italic}blockquote:before,blockquote:after{font-family:old standard tt,serif;content:'\201C';font-size:35px;color:#403c3b}blockquote:after{content:'\201D'}hr{width:40%;height:1px;background:#403c3b;margin:25px auto}h1{font-size:35px}h2{font-size:28px}h3{font-size:22px;margin-top:18px}h1 a,h2 a,h3 a{text-decoration:none}h1,h2{margin-top:28px}#sub-header,.date{color:#403c3b;font-size:13px}#sub-header{margin:0 4px}#nav h1 a{font-size:35px;color:#1d1313;line-height:120%}.posts_listing a,#nav a{text-decoration:none}li{margin-left:20px}ul li{margin-left:5px}ul li{list-style-type:none}ul li:before{content:"\00BB \0020"}#nav ul li:before,.posts_listing li:before{content:'';margin-right:0}#content{text-align:left;width:100%;font-size:15px;padding:60px 0 80px}#content h1,#content h2{margin-bottom:5px}#content h2{font-size:25px}#content .entry-content{margin-top:15px}#content .date{margin-left:3px}#content h1{font-size:30px}.highlight{margin:10px 0}.posts_listing{margin:0 0 50px}.posts_listing li{margin:0 0 25px 15px}.posts_listing li a:hover,#nav a:hover{text-decoration:underline}#nav{text-align:center;position:static;margin-top:60px}#nav ul{display:table;margin:8px auto 0}#nav li{list-style-type:none;display:table-cell;font-size:15px;padding:0 20px}#links{margin:50px 0 0}#links :nth-child(2){float:right}#not-found{text-align:center}#not-found a{font-family:old standard tt,serif;font-size:200px;text-decoration:none;display:inline-block;padding-top:225px}@media(max-width:750px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:28px}#nav li{font-size:13px;padding:0 15px}#content{margin-top:0;padding-top:50px;font-size:14px}#content h1{font-size:25px}#content h2{font-size:22px}.posts_listing li div{font-size:12px}}@media(max-width:400px){body{padding-left:20px;padding-right:20px}#nav h1 a{font-size:22px}#nav li{font-size:12px;padding:0 10px}#content{margin-top:0;padding-top:20px;font-size:12px}#content h1{font-size:20px}#content h2{font-size:18px}.posts_listing li div{font-size:12px}}*,#nav h1 a{color:#fdfdfd}body{background:#121212}pre,code{background-color:#262626}#sub-header,.date{color:#bababa}hr{background:#ebebeb}:root{--darkreader-neutral-background:#181a1b;--darkreader-neutral-text:#e8e6e3;--darkreader-selection-background:#004daa;--darkreader-selection-text:#e8e6e3}html{background-color:#181a1b!important}html,body,input,textarea,select,button{background-color:#181a1b}html,body,input,textarea,select,button{border-color:#736b5e;color:#e8e6e3}a{color:#3391ff}table{border-color:#545b5e}::placeholder{color:#b2aba1}input:-webkit-autofill,textarea:-webkit-autofill,select:-webkit-autofill{background-color:#555b00!important;color:#e8e6e3!important}::-webkit-scrollbar{background-color:#202324;color:#aba499}::-webkit-scrollbar-thumb{background-color:#454a4d}::-webkit-scrollbar-thumb:hover{background-color:#575e62}::-webkit-scrollbar-thumb:active{background-color:#484e51}::-webkit-scrollbar-corner{background-color:#181a1b}*{scrollbar-color:#202324 #454a4d}::selection{background-color:#004daa!important;color:#e8e6e3!important}::-moz-selection{background-color:#004daa!important;color:#e8e6e3!important}</style></head><body><section id=nav><h1><a href=https://chrsm.org/></a></h1><ul><li><a href=https://chrsm.org/>~/</a></li><li><a href=https://chrsm.org/about>~/about</a></li><li><a href=https://github.com/chrsm>~/github</a></li></ul></section><section id=content><h1>neovim: refactored config</h1><div id=sub-header>April 2022 Â· 4 minute read</div><div class=entry-content><p>Roughly two years ago, <a href=https://chrsm.org/2020/03/02/vim-plugins-i-use/>I wrote about what Vim plugins I use</a>. At that time
I was using Neovim much as I had always used Vim before. Since then, Neovim has
evolved and so has the ecosystem of plugins around it.</p><p>In <a href=https://github.com/chrsm/dotfiles/commit/4a0db79aa6f2654261ab0e44b260d13362325a0f>late 2021, I finally refactored my vimrc into Lua</a> - more specifically,
writing it in <a href=https://github.com/pigpigyyy/Yuescript>Yuescript</a> and compiling it into Lua. Lua is definitely one
of my favorite languages, but yue has quickly become my quick-and-dirty
scripting language of choice.</p><p>Yuescript is an evolution of <a href=https://github.com/leafo/moonscript>leafo&rsquo;s moonscript</a> - actively maintained,
updated, and the author frequently takes user feedback into account.</p><h2 id=warning-note-idk>Warning? Note? IDK.</h2><p>While I am not here to sell yue, all of my code snippets henceforth are
written in yue, <em>not</em> Lua. Some of it is supported by moonscript,
and some of it is beyond moonscript&rsquo;s feature set.</p><h1 id=configuration>Configuration</h1><p>I won&rsquo;t go over every aspect of my config. It should be easy enough to jump
through. Really just wanted to dump info about the general layout.</p><h2 id=building>Building</h2><p>I like to keep it simple (because I&rsquo;m stupid), so I have a very simple Makefile
that I use for working on my configuration.</p><pre tabindex=0><code>build:
	yue init.yue
	cd lua &amp;&amp; yue .

clean:
	rm init.lua
	cd lua &amp;&amp; find . -type f -name &#39;*.lua&#39; -delete

install:
	nvim --headless -c &#39;autocmd User PackerComplete quitall&#39; -c &#39;PackerSync&#39;
</code></pre><p>My workflow is generally: change something, <code>make</code>, restart vim or <code>:PackerCompile</code>.
If new plugins have been added, I tend to quit and run <code>make install</code>.</p><h2 id=init>init</h2><p>I don&rsquo;t set up anything other than plugins unless packer exists already.
If I am bootstrapping a new install, only plugins are included and sync&rsquo;d.</p><pre tabindex=0><code>-- init.yue
needs_bootstrap = false
with vim.fn
  p = (.stdpath &#34;data&#34;) .. &#34;/site/pack/packer/start/packer.nvim&#34;
  if .empty(.glob p) &gt; 0
    needs_bootstrap = .system {
      &#34;git&#34;, &#34;clone&#34;, &#34;--depth&#34;, &#34;1&#34;,
      &#34;https://github.com/wbthomason/packer.nvim&#34;, p
    }

-- lua/plugins.yue, inside of `packer.setup`
-- will quit vim after plugins have been installed &amp; packer has finished its compile
      if needs_bootstrap
        -- basically used to &#34;pause&#34; and remind me it&#39;ll quit
        vim.fn.input &#34;bootstrapping, press any key (exit after)&#34;
        vim.api.nvim_create_autocmd { &#34;User PackerCompileDone&#34; }
          command: &#34;qall&#34;
        require(&#34;packer&#34;).install!
        require(&#34;packer&#34;).compile!
</code></pre><h2 id=layout>Layout</h2><p>I personally prefer to separate things into small chunks wherever possible, so
<a href=https://github.com/chrsm/dotfiles/tree/master/neovim/.config/nvim>my setup looks a bit wild</a> at first glance.</p><pre tabindex=0><code>lua/
   macros.yue

   plugins.yue
      (list of plugins to include)
   plug/
      (plugin specific configs)

   settings.yue
   keymaps.yue

   nvim_lsp.yue
      (I plan on refactoring this for per-lang settings)

   ft.yue
      (imports ft specific configs)
   ft/
      (filetype specific configs)
</code></pre><p>I require/exec these in order, so:</p><ul><li>plugins</li><li>settings</li><li>keymaps</li><li>lsp</li><li>ft</li></ul><p>Each of these is essentially it&rsquo;s own module that has a <code>setup</code> function.
The simplest one is <code>ft</code>:</p><pre tabindex=0><code>types =
  * &#34;yue&#34;
  * &#34;go&#34;
  * &#34;cpp&#34;
  * &#34;lua&#34;

export default {
  setup: -&gt;
    require &#34;ft.#{ft}&#34; for _, ft in ipairs types
}
</code></pre><p>This allows me to separate the configuration from execution. A simple <code>import</code>
(<code>require</code> in standard lua) won&rsquo;t trigger a bunch of errors in a bootstrap
scenario.</p><h2 id=per-plugin-configuration>Per-Plugin Configuration</h2><p>Thankfully, the majority of plugins I use have excellent defaults and don&rsquo;t
require much additional configuration.</p><p>Exactly like my use of top-level initialization, each plugin configuration
exports a setup function that will be called, separating the actual config
from the execution of it for the plugin.</p><p>As an example, here&rsquo;s how I configure <a href=https://github.com/TimUntersberger/neogit>TimUntersberger/neogit</a>.</p><pre tabindex=0><code>-- neogit.yue
import &#34;macros&#34; as { $ }

cfg =
  kind: &#34;split&#34;
  integrations:
    diffview: true

export default {
  setup: (...) -&gt;
    ng = require &#34;neogit&#34;
    
    ng.setup cfg

    $nosilent &#39;&lt;leader&gt;g&#39;, &#39;&lt;cmd&gt;Neogit&lt;CR&gt;&#39;
}
</code></pre><p>As you can see, the configuration is outside of the actual setup, which
subjectively looks nicer and lets it lean left as much as possible.</p><p>Additionally, keybinds are specified at execution time, so if a plugin
is not loaded, it doesn&rsquo;t try to map something that doesn&rsquo;t exist.</p><p>It&rsquo;s not always possible, as some things rely on functions provided by a
package, i.e. <a href=https://github.com/hrsh7th/nvim-cmp>hrsh7th/cmp</a> - I set up actual mappings during setup,
as otherwise it&rsquo;s possible for <code>cmp</code> to not be installed.</p><pre tabindex=0><code>cfg =
  snippet:
    expand: (args) -&gt;
      require(&#34;luasnip&#34;).lsp_expand args.body
  sources:
    * name: &#39;nvim_lsp&#39;
    * name: &#39;buffer&#39;

export default {
  setup: (...) -&gt;
    import &#34;cmp&#34; as cmp

    -- cmp is available, set up mappings here
    cfg.mapping =
      &#39;&lt;C-d&gt;&#39;: cmp.mapping.scroll_docs -4
      &#39;&lt;C-f&gt;&#39;: cmp.mapping.scroll_docs 4
      &#39;&lt;C-Space&gt;&#39;: cmp.mapping.complete!
      &#39;&lt;Tab&gt;&#39;: cmp.mapping cmp.mapping.select_next_item!, { &#39;i&#39;, &#39;s&#39; }
      &#39;&lt;C-e&gt;&#39;: cmp.mapping.close!
      &#39;&lt;CR&gt;&#39;: cmp.mapping.confirm
        select: true
        behavior: cmp.ConfirmBehavior.Replace
      &#39;&lt;Up&gt;&#39;: cmp.mapping cmp.mapping.select_prev_item!, { &#39;i&#39;, &#39;s&#39; }
      &#39;&lt;Down&gt;&#39;: cmp.mapping cmp.mapping.select_next_item!, { &#39;i&#39;, &#39;s&#39; }

    cmp.setup cfg
}
</code></pre><h1 id=wq>;wq</h1><p>That&rsquo;s it for now. Honestly not even sure what I was originally going for by
writing this, but now I&rsquo;m bored. Bye!</p></div><div id=links><a class="basic-alignment left" href=https://chrsm.org/2022/02/28/opinion-vcs-commits/>&#171; Opinion: VCS Commits</a>
<a class="basic-alignment left" href=https://chrsm.org/2022/09/10/taking-a-break/>Taking a Break &#187;</a></div></section></body></html>